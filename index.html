import logging
from datetime import datetime, date
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
    ConversationHandler
)
import sqlite3
import os

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–æ–≤ ===
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
ACTION, CUSTOM_ACTION = range(2)
DB_PATH = os.getenv('DATABASE_URL', 'bizstreak.db')

# === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î ===
def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            streak INTEGER DEFAULT 0,
            last_action_date TEXT
        )
    ''')
    c.execute('''
        CREATE TABLE IF NOT EXISTS actions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            action_text TEXT,
            date TEXT
        )
    ''')
    conn.commit()
    conn.close()

# === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
def get_user(user_id):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT streak, last_action_date FROM users WHERE user_id = ?", (user_id,))
    row = c.fetchone()
    conn.close()
    return row

def update_streak(user_id):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    today = str(date.today())
    c.execute("SELECT streak, last_action_date FROM users WHERE user_id = ?", (user_id,))
    row = c.fetchone()
    if row:
        streak, last_date = row
        if last_date == today:
            # –£–∂–µ —Å–¥–µ–ª–∞–ª —Å–µ–≥–æ–¥–Ω—è
            conn.close()
            return streak, False
        elif last_date == str(date.today().strftime('%Y-%m-%d')):
            pass
        elif last_date == str(date.today().strftime('%Y-%m-%d')):
            pass
        elif last_date == str(date.today() - timedelta(days=1)):
            new_streak = streak + 1
        else:
            new_streak = 1
    else:
        new_streak = 1
    c.execute("INSERT OR REPLACE INTO users (user_id, streak, last_action_date) VALUES (?, ?, ?)",
              (user_id, new_streak, today))
    conn.commit()
    conn.close()
    return new_streak, True

def save_action(user_id, text):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT INTO actions (user_id, action_text, date) VALUES (?, ?, ?)",
              (user_id, text, str(date.today())))
    conn.commit()
    conn.close()

# === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        ["üî• –°–¥–µ–ª–∞—Ç—å —à–∞–≥"],
        ["üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å", "üí° –ê—Ä—Ö–∏–≤ –∏–¥–µ–π"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî **BizStreak**.\n\n"
        "–¢–≤–æ—è —Ü–µ–ª—å ‚Äî –¥–µ–ª–∞—Ç—å **1 –º–∏–∫—Ä–æ-–¥–µ–π—Å—Ç–≤–∏–µ –≤ –¥–µ–Ω—å** –¥–ª—è —Å–≤–æ–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞.\n"
        "–î–∞–∂–µ 5 –º–∏–Ω—É—Ç ‚Äî —ç—Ç–æ —É–∂–µ –ø–æ–±–µ–¥–∞.\n\n"
        "–ù–∞–∂–º–∏ ¬´üî• –°–¥–µ–ª–∞—Ç—å —à–∞–≥¬ª ‚Äî –∏ –Ω–∞—á–Ω–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!",
        parse_mode='Markdown',
        reply_markup=reply_markup
    )

async def show_action_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    actions = [
        "üìù –ó–∞–ø–∏—Å–∞—Ç—å –∏–¥–µ—é",
        "üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É",
        "üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—á–µ—Ä–∞—à–Ω–∏–π —à–∞–≥",
        "‚úèÔ∏è –°–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ"
    ]
    keyboard = [[a] for a in actions]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)
    await update.message.reply_text("–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=reply_markup)
    return ACTION

async def handle_action(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text

    if text == "‚úèÔ∏è –°–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ":
        await update.message.reply_text("–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç—ã —Å–¥–µ–ª–∞–µ—à—å —Å–µ–≥–æ–¥–Ω—è:")
        return CUSTOM_ACTION

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    action_map = {
        "üìù –ó–∞–ø–∏—Å–∞—Ç—å –∏–¥–µ—é": "–ó–∞–ø–∏—Å–∞–ª –∏–¥–µ—é",
        "üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É": "–ù–∞–ø–∏—Å–∞–ª –∫–ª–∏–µ–Ω—Ç—É",
        "üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—á–µ—Ä–∞—à–Ω–∏–π —à–∞–≥": "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≤—á–µ—Ä–∞—à–Ω–∏–π —à–∞–≥"
    }
    log_text = action_map.get(text, text)
    save_action(user_id, log_text)
    streak, is_new = update_streak(user_id)

    if is_new:
        await update.message.reply_text(
            f"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –≠—Ç–æ —Ç–≤–æ–π **{streak}-–π –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥**!\n\n"
            "–ù–µ –ø—Ä–µ—Ä—ã–≤–∞–π —Ü–µ–ø–æ—á–∫—É ‚Äî –∑–∞–≤—Ç—Ä–∞ —Å–Ω–æ–≤–∞ –∂–¥—É —Ç–µ–±—è!",
            reply_markup=ReplyKeyboardMarkup([
                ["üî• –°–¥–µ–ª–∞—Ç—å —à–∞–≥"],
                ["üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å", "üí° –ê—Ä—Ö–∏–≤ –∏–¥–µ–π"]
            ], resize_keyboard=True)
        )
    else:
        await update.message.reply_text(
            "–¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª —à–∞–≥ —Å–µ–≥–æ–¥–Ω—è! –ú–æ–ª–æ–¥–µ—Ü!",
            reply_markup=ReplyKeyboardMarkup([
                ["üî• –°–¥–µ–ª–∞—Ç—å —à–∞–≥"],
                ["üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å", "üí° –ê—Ä—Ö–∏–≤ –∏–¥–µ–π"]
            ], resize_keyboard=True)
        )
    return ConversationHandler.END

async def handle_custom_action(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = f"–°–¥–µ–ª–∞–ª: {update.message.text}"
    save_action(user_id, text)
    streak, is_new = update_streak(user_id)

    if is_new:
        await update.message.reply_text(
            f"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –≠—Ç–æ —Ç–≤–æ–π **{streak}-–π –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥**!",
            reply_markup=ReplyKeyboardMarkup([
                ["üî• –°–¥–µ–ª–∞—Ç—å —à–∞–≥"],
                ["üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å", "üí° –ê—Ä—Ö–∏–≤ –∏–¥–µ–π"]
            ], resize_keyboard=True)
        )
    else:
        await update.message.reply_text("–¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª —à–∞–≥ —Å–µ–≥–æ–¥–Ω—è!")

    return ConversationHandler.END

async def show_progress(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    row = get_user(user_id)
    if row:
        streak, last_date = row
        await update.message.reply_text(
            f"üìà –¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å:\n\n"
            f"üî• –¶–µ–ø–æ—á–∫–∞ –¥–Ω–µ–π: **{streak}**\n"
            f"üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {last_date}",
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text("–¢—ã –µ—â—ë –Ω–µ —Å–¥–µ–ª–∞–ª –Ω–∏ –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞. –ù–∞—á–Ω–∏ —Å–µ–≥–æ–¥–Ω—è!")

async def show_archive(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT action_text, date FROM actions WHERE user_id = ? ORDER BY date DESC LIMIT 10", (user_id,))
    rows = c.fetchall()
    conn.close()

    if rows:
        msg = "üí° –¢–≤–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —à–∞–≥–∏:\n\n"
        for action, d in rows:
            msg += f"‚Ä¢ {d}: {action}\n"
        await update.message.reply_text(msg)
    else:
        await update.message.reply_text("–¢–≤–æ–π –∞—Ä—Ö–∏–≤ –ø—É—Å—Ç. –°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π —à–∞–≥!")

# === –ó–∞–ø—É—Å–∫ ===
def main():
    init_db()
    TOKEN = os.getenv("BOT_TOKEN")
    if not TOKEN:
        raise ValueError("–î–æ–±–∞–≤—å BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

    app = Application.builder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üî• –°–¥–µ–ª–∞—Ç—å —à–∞–≥$"), show_action_menu)],
        states={
            ACTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_action)],
            CUSTOM_ACTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_custom_action)],
        },
        fallbacks=[CommandHandler("start", start)]
    )

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Regex("^üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å$"), show_progress))
    app.add_handler(MessageHandler(filters.Regex("^üí° –ê—Ä—Ö–∏–≤ –∏–¥–µ–π$"), show_archive))
    app.add_handler(conv_handler)

    app.run_polling()

if __name__ == "__main__":
    main()
